graph TD
    subgraph "Giai Äoáº¡n 1: Indexing (Offline) - Cháº¡y build_index.py"
        direction LR
        
        Input[("ğŸ“<br>ThÆ° má»¥c data/<br>chá»©a video.mp4, image.jpg")] --> PreProcess{{"âš™ï¸<br><b>build_index.py</b><br>Khá»Ÿi cháº¡y xá»­ lÃ½"}}
        
        PreProcess --> AudioIndexer["<br><b>AudioIndexer</b><br>(Xá»­ lÃ½ Ã‚m thanh)"]
        PreProcess --> VisualIndexer["<br><b>VisualIndexer</b><br>(Xá»­ lÃ½ HÃ¬nh áº£nh)"]
        
        subgraph "NhÃ¡nh Audio"
            direction TB
            AudioIndexer --> Whisper[/"ğŸ¤–<br><b>Whisper Model</b><br>BÃ³c tÃ¡ch lá»i thoáº¡i"/]
            Whisper --> Transcripts[("ğŸ“„<br><b>output/transcripts/</b><br>CÃ¡c file {id}.json")]
        end
        
        subgraph "NhÃ¡nh Visual"
            direction TB
            VisualIndexer --> OpenCV[/"âš™ï¸<br><b>OpenCV</b><br>TrÃ­ch xuáº¥t Frames tá»« Video"/]
            OpenCV --> Frames[("ğŸ–¼ï¸<br><b>output/frames/</b><br>CÃ¡c file frame.jpg")]
            
            Frames --> CLIP_Model
            Input -- áº¢nh tÄ©nh --> CLIP_Model[/"ğŸ¤–<br><b>CLIP Model</b><br>Táº¡o Vector Embeddings"/]
            
            CLIP_Model --> FAISS[/"ğŸ’¾<br><b>FAISS</b><br>XÃ¢y dá»±ng Chá»‰ má»¥c Vector"/]
            FAISS --> IndexFile[("ğŸ“‡<br><b>faiss_visual.index</b>")]
            FAISS --> MappingFile[("ğŸ—ºï¸<br><b>index_to_media_data.json</b>")]
        end

    end
    
    style Input fill:#e6fffa,stroke:#00796b
    style PreProcess fill:#fff3e0,stroke:#f57c00
    style AudioIndexer fill:#e3f2fd,stroke:#1976d2
    style VisualIndexer fill:#e3f2fd,stroke:#1976d2
    style Transcripts fill:#d1c4e9,stroke:#512da8
    style IndexFile fill:#d1c4e9,stroke:#512da8
    style MappingFile fill:#d1c4e9,stroke:#512da8
    style Frames fill:#fce4ec,stroke:#c2185b

graph TD
    subgraph "Giai Äoáº¡n 2: Searching (Online) - Cháº¡y main.py"
        direction TB

        User(ğŸ‘¨â€ğŸ’»<br>NgÆ°á»i dÃ¹ng) -- "POST /unified_search<br>text_query: 'dog on beach'" --> API{"<br><b>APIServer</b><br>(FastAPI)"}

        subgraph "Táº£i vÃ o RAM lÃºc khá»Ÿi Ä‘á»™ng"
            direction LR
            TranscriptsDB[("ğŸ“„<br>Transcripts")]
            FAISS_DB[("ğŸ“‡<br>FAISS Index")]
            Mapping_DB[("ğŸ—ºï¸<br>Mapping Data")]
        end
        
        TranscriptsDB -- Load --> API
        FAISS_DB -- Load --> API
        Mapping_DB -- Load --> API

        API --> SearchAudio["<br><b>TÃ¬m kiáº¿m Audio</b><br>(Keyword Search)"]
        API --> SearchVisual["<br><b>TÃ¬m kiáº¿m Visual</b><br>(Vector Search)"]
        
        subgraph "TÃ¬m kiáº¿m"
            direction LR
            SearchAudio -- "DÃ¹ng Transcripts trong RAM" --> AudioResults[("ğŸ“‹<br>Káº¿t quáº£ Audio<br>ID, start, end")]
            
            SearchVisual -- "DÃ¹ng FAISS & Mapping trong RAM" --> VisualResults[("ğŸ“‹<br>Káº¿t quáº£ Visual<br>ID, timestamp")]
        end

        AudioResults --> Fusion["<br><b>Há»£p nháº¥t (RRF)</b>"]
        VisualResults --> Fusion["<br><b>Há»£p nháº¥t (RRF)</b>"]
        
        Fusion --> FinalList[("ğŸ†<br>Danh sÃ¡ch<br>xáº¿p háº¡ng cuá»‘i cÃ¹ng")]
        FinalList -- "Pháº£n há»“i JSON" --> User

    end

    style User fill:#e6fffa,stroke:#00796b
    style API fill:#fff3e0,stroke:#f57c00
    style TranscriptsDB fill:#d1c4e9,stroke:#512da8
    style FAISS_DB fill:#d1c4e9,stroke:#512da8
    style Mapping_DB fill:#d1c4e9,stroke:#512da8
    style SearchAudio fill:#e3f2fd,stroke:#1976d2
    style SearchVisual fill:#e3f2fd,stroke:#1976d2
    style Fusion fill:#ffcdd2,stroke:#d32f2f
    style FinalList fill:#c8e6c9,stroke:#388e3c

